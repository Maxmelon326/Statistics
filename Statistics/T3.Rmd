```{r}
#Q1 Define and print sting.

# Define the string
task_description <- "Name: LI WAN, Unit Name: SIT741, Task Name: T03.P1"

# Print the string
cat(task_description, "\n")


```
```{r}
#Q2 Read dataset
#install.packages("readr")
library(readr)

# Correct URL for raw CSV file
url <- "https://raw.githubusercontent.com/tidyverse/nycflights13/main/data-raw/weather.csv"

# Read the CSV file using read_csv from the readr package
weather <- read_csv(url)
# View the first few rows of the dataset
head(weather)


```
```{r}
#Q3 Print variables names/types, select wind_speed and 1 other variable for the next tasks.
str(weather)
select_columns<-c("wind_speed","temp")
weather_selected<-weather[select_columns]
head(weather_selected)
#print(weather.select_columns)
```

```{r}
#Q4 Provide QQ plots and histograms for the selected 2 variables(with and without ourliers).
library(tidyverse)
library(fitdistrplus)
# Function to remove outliers using IQR method
remove_outliers <- function(data, column) {
  Q1 <- quantile(data[[column]], 0.25, na.rm = TRUE)
  Q3 <- quantile(data[[column]], 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  data %>% filter(data[[column]] >= lower_bound & data[[column]] <= upper_bound)
}

# Function to create histograms and QQ plots for a given variable
plot_histogram_qq <- function(data, column) {
  data_no_outliers <- remove_outliers(data, column)
  
  # Histogram with outliers
  hist_plot_with_outliers <- ggplot(data, aes_string(x = column)) +
    geom_histogram(binwidth = 1) +
    labs(title = paste("Histogram of", column, "(With Outliers)"), x = column, y = "Frequency") +
    theme_minimal()
  
  # Histogram without outliers
  hist_plot_without_outliers <- ggplot(data_no_outliers, aes_string(x = column)) +
    geom_histogram(binwidth = 1) +
    labs(title = paste("Histogram of", column, "(Without Outliers)"), x = column, y = "Frequency") +
    theme_minimal()
  
  # QQ Plot with outliers
  qq_plot_with_outliers <- ggplot(data, aes_string(sample = column)) +
    geom_qq() +
    geom_qq_line() +
    labs(title = paste("QQ Plot of", column, "(With Outliers)"), x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_minimal()
  
  # QQ Plot without outliers
  qq_plot_without_outliers <- ggplot(data_no_outliers, aes_string(sample = column)) +
    geom_qq() +
    geom_qq_line() +
    labs(title = paste("QQ Plot of", column, "(Without Outliers)"), x = "Theoretical Quantiles", y = "Sample Quantiles") +
    theme_minimal()
  
  # Print plots
  print(hist_plot_with_outliers)
  print(hist_plot_without_outliers)
  print(qq_plot_with_outliers)
  print(qq_plot_without_outliers)
}

# Apply the function to wind_speed and temp
plot_histogram_qq(weather, "wind_speed")
plot_histogram_qq(weather, "temp")


```


From the above graphs, we can see the outliers of wind_speed have some very obvious outliers while the outliers of temp do not affect the distribution appearance very much. According to the histograms, the wind speed looks like normal distribution despites of outliers, while the temp like mixture of two normal distributions. 


```{r}
#Q5 For one of the variables, generate simulated data using an appropriate distribution and compare the Cullen and Frey graph with that for the original distribution.
library(magrittr)
clean_data <- weather %>%
  filter(!is.na(temp) & is.finite(temp))
clean_data %$% 
  descdist(temp, boot = 100)
```
According to the Cullen and Frey graph, we can guess temp could be uniform distribution.
```{r}
# Filter the data to remove rows with NA or non-finite values in temp 
#clean_data <- weather %>%
 # filter(!is.na(temp) & is.finite(temp))

# Fit the normal distribution for wind_speed
#fit <- fitdist(clean_data$wind_speed, "norm")

# Generate simulated data based on the fitted uniform distribution
simulated_data <- clean_data %>% 
  mutate(simulated_temp = runif(n = n(),
                                min = min(temp, na.rm = TRUE),
                                max = max(temp, na.rm = TRUE)))

simulated_data %>% 
  ggplot(aes(x = simulated_temp)) +
  geom_histogram()

simulated_data %>% 
  ggplot(aes(sample = simulated_temp)) +
  geom_qq()

simulated_data %$%  
  descdist(simulated_temp, boot = 100)

```
The simulated temp is perfectly matched with Uniform distribution in Cullen and Frey Graph. While the simulated_temp is very different from the original data. In original data, frequencies are usually under 400, but the simulated data cut the fluctuation and makes the data very flat due to the uniform assumption.

```{r}
#Q6&Q7 MLE fit of your data and display the estimates and comments.
# Wind_speed
clean_data1 <- weather %>%
  filter(!is.na(wind_speed) & is.finite(wind_speed))
estimate <- clean_data1%$%
  fitdist(data = wind_speed, 
          distr = "norm")
estimate %>% 
  plot

```


Wind speed:
Density Plot (Empirical and theoretical densities):
The histogram (empirical data) and the red line (theoretical normal distribution) show a significant discrepancy. The empirical data is heavily skewed towards the left, with a long tail extending towards the right, which is not typical of a normal distribution.

Q-Q Plot (Quantile-Quantile Plot):
The Q-Q plot shows the empirical quantiles versus the theoretical quantiles. Ideally, if the data fits the normal distribution well, the points should lie along the reference line (diagonal line). In this plot, the points are far from the reference line, especially at the extremes, indicating a poor fit.

Empirical and theoretical CDFs (Cumulative Distribution Functions):
The empirical CDF (black) and the theoretical CDF (red) should closely match if the fit is good. Here, the empirical CDF rises very steeply initially and then flattens out, while the theoretical CDF is a straight line. This further indicates that the normal distribution does not fit the data well.

P-P Plot (Probability-Probability Plot):
Similar to the Q-Q plot, the P-P plot compares the cumulative probabilities of the empirical and theoretical distributions. A good fit would show points close to the reference line. In this case, the points deviate significantly from the line, especially at the lower probabilities, indicating a poor fit.

Conclusion: The fitting is poor.
```{r}
estimate <- clean_data%$%
  fitdist(data = temp, 
          distr = "unif")
estimate %>% 
  plot
```



Temp:
Density Plot (Empirical and theoretical densities):
The histogram (empirical data) and the red line (theoretical uniform distribution) show that the empirical data appears more uniformly distributed, and the theoretical uniform density line aligns better with the data, although there are still some deviations.

Q-Q Plot (Quantile-Quantile Plot):
The Q-Q plot shows the empirical quantiles versus the theoretical quantiles. Ideally, if the data fits the uniform distribution well, the points should lie along the reference line (diagonal line). In this plot, the points follow the reference line more closely, but there are deviations at the tails, indicating some departure from the uniform distribution.

Empirical and theoretical CDFs (Cumulative Distribution Functions):
The empirical CDF (black) and the theoretical CDF (red) should closely match if the fit is good. Here, the empirical CDF and the theoretical CDF are more aligned than in the previous example, but there are still noticeable deviations, particularly at the tails.

P-P Plot (Probability-Probability Plot):
Similar to the Q-Q plot, the P-P plot compares the cumulative probabilities of the empirical and theoretical distributions. A good fit would show points close to the reference line. In this case, the points are closer to the reference line compared to the previous example, but there are still deviations, particularly at the lower and higher probabilities.

The fitting is moderate. 


What if we try other distributions for Wind_speed and Temp. We can try for wind_speed and gamma for Temp.

```{r}
# Wind_speed

# Clean the data to include only positive wind_speed values
clean_data1 <- weather %>%
  filter(!is.na(wind_speed) & is.finite(wind_speed) & wind_speed > 0)

# Fit a xx distribution
estimate <- fitdist(clean_data1$wind_speed, distr = "weibull")

estimate %>% 
  plot

```


Wind speed:
We also tried weibull and gamma. The result is stll not improved compared with normal distribution assupmtion.  

```{r}
estimate <- clean_data%$%
  fitdist(data = temp, 
          distr = "gamma")
estimate %>% 
  plot
```


Temp:
We can see temp is better fitting gamma distribution. 

Next step, we can explore to try Statistical Tests to compare different fitting choice like Chi-Squared Test.
